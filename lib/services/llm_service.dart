import 'package:http/http.dart' as http;
import 'dart:convert';

class LLMService {
  // –Ø–Ω–¥–µ–∫—Å Cloud Credentials
  static const String _apiKey = 'test';
  static const String _folderId = 'test1';
  static const String _apiEndpoint =
      'https://llm.api.cloud.yandex.net/foundationModels/v1/completion';

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π API (–Ω–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
  static const bool _useTestMode = false;

  static Future<String> generateResponse(String userMessage) async {
    if (_useTestMode) {
      return _getTestResponse(userMessage);
    }

    try {
      print('üîµ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ –Ø–Ω–¥–µ–∫—Å GPT...');
      print('–°–æ–æ–±—â–µ–Ω–∏–µ: $userMessage');

      final response = await http.post(
        Uri.parse(_apiEndpoint),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Api-Key $_apiKey',
        },
        body: jsonEncode({
          'modelUri': 'gpt://$_folderId/yandexgpt/latest',
          'completionOptions': {
            'stream': false,
            'temperature': 0.5,
            'maxTokens': '500',
          },
          'messages': [
            {
              'role': 'system',
              'text':
              '–¢—ã –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∞ –ø–æ –∏–º–µ–Ω–∏ –ú–∏—Ä–∞. –ü–æ–º–æ–≥–∞–µ—à—å –ª—é–¥—è–º —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º –∏ —Ç—Ä–µ–≤–æ–≥–æ–π. '
                  '–ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏–∫–∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏ –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏. '
                  '–ë—É–¥—å –º—è–≥–∫–∏–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º –∏ —Å–æ—á—É–≤—Å—Ç–≤—É—é—â–∏–º. '
                  '–ù–µ —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –Ω–µ –¥–∞—ë—à—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã. '
                  '–ü—Ä–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö —Ä–∏—Å–∫–∞ —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –∏–ª–∏ —Å—É–∏—Ü–∏–¥–∞, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—É –∏ –¥–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã –≥–æ—Ä—è—á–∏—Ö –ª–∏–Ω–∏–π. '
                  '–¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∏ –ø–æ–Ω—è—Ç–Ω—ã–º–∏ (100-200 —Å–ª–æ–≤).',
            },
            {
              'role': 'user',
              'text': userMessage,
            }
          ],
        }),
      );

      print('–°—Ç–∞—Ç—É—Å –∫–æ–¥: ${response.statusCode}');
      print('–û—Ç–≤–µ—Ç: ${response.body}');

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final result = data['result']['alternatives'][0]['message']['text'];
        print('‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –æ—Ç –Ø–Ω–¥–µ–∫—Å API');
        return result as String;
      } else if (response.statusCode == 401) {
        print('‚ùå –û—à–∏–±–∫–∞ 401: –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á');
        return '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á.';
      } else if (response.statusCode == 429) {
        print('‚ö†Ô∏è –û—à–∏–±–∫–∞ 429: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤');
        return '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
      } else {
        print('‚ùå –û—à–∏–±–∫–∞ ${response.statusCode}');
        return '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–∏—Å—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
      }
    } catch (e) {
      print('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: $e');
      return '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –û—à–∏–±–∫–∞: $e';
    }
  }

  static String _getTestResponse(String userMessage) {
    final lowerMessage = userMessage.toLowerCase();

    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (lowerMessage.contains('—Å—Ç—Ä–µ—Å—Å') || lowerMessage.contains('–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ')) {
      return '–Ø —Å–ª—ã—à—É, —á—Ç–æ —Ç—ã –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å —Å—Ç—Ä–µ—Å—Å. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî —Å—Ç—Ä–µ—Å—Å —á–∞—Å—Ç—å –∂–∏–∑–Ω–∏. '
          '–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç. '
          '–ö–∞–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ –º—ã—Å–ª—å –≤—ã–∑–≤–∞–ª–∞ —ç—Ç–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ?';
    } else if (lowerMessage.contains('—Ç—Ä–µ–≤–æ–≥') || lowerMessage.contains('–±–µ—Å–ø–æ–∫–æ–π')) {
      return '–ü–æ—Ö–æ–∂–µ, —É —Ç–µ–±—è –º–Ω–æ–≥–æ –º—ã—Å–ª–µ–π –≤ –≥–æ–ª–æ–≤–µ. –¢—Ä–µ–≤–æ–≥–∞ —á–∞—Å—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –º—ã –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ —Ç–æ–º, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏. '
          '–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π –º–æ–º–µ–Ω—Ç. –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å, —Å–ª—ã—à–∏—à—å, —á—É–≤—Å—Ç–≤—É–µ—à—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?';
    } else if (lowerMessage.contains('–≤—ã–≥–æ—Ä–∞–Ω') || lowerMessage.contains('—É—Å—Ç–∞–ª—å')) {
      return '–í—ã–≥–æ—Ä–∞–Ω–∏–µ ‚Äî —ç—Ç–æ —Å–µ—Ä—å—ë–∑–Ω—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç —Ç–≤–æ–µ–≥–æ —Ç–µ–ª–∞ –∏ –ø—Å–∏—Ö–∏–∫–∏. '
          '–ü–æ—Ö–æ–∂–µ, —Ç—ã –¥–∞—ë—à—å —Å–µ–±–µ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –∑–∞–¥–∞—á. '
          '–ö–æ–≥–¥–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ —Ç—ã –ø–æ–∑–≤–æ–ª–∏–ª —Å–µ–±–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å?';
    } else if (lowerMessage.contains('–ø—Ä–∏–≤–µ—Ç')) {
      return '–ü—Ä–∏–≤–µ—Ç! üëã –†–∞–¥ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è. –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–±—è. '
          '–ö–∞–∫ –¥–µ–ª–∞? –ß—Ç–æ —Ç–µ–±—è —Å–µ–π—á–∞—Å –∑–∞–Ω–∏–º–∞–µ—Ç –∏–ª–∏ –≤–æ–ª–Ω—É–µ—Ç?';
    } else {
      return '–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è. –Ø —Å–ª—ã—à—É —Ç–µ–±—è. '
          '–î–∞–≤–∞–π –≥–ª—É–±–∂–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –≤ —Ç–æ–º, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å. '
          '–ú–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π?';
    }
  }
}
